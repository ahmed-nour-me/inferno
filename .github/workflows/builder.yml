name: Build Inferno USB Creator

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
      
    - name: Setup MSVC
      uses: ilammy/msvc-dev-cmd@v1
      
    - name: Create build directory
      run: mkdir build
      
    - name: Compile Inferno
      shell: cmd
      run: |
        cl.exe /EHsc /std:c++17 /O2 /MT ^
        /D_UNICODE /DUNICODE ^
        /I"%INCLUDE%" ^
        /Fe:build\Inferno.exe ^
        inferno.cpp ^
        /link ^
        user32.lib gdi32.lib comctl32.lib comdlg32.lib ^
        shell32.lib ole32.lib setupapi.lib ^
        /SUBSYSTEM:WINDOWS ^
        /MANIFESTUAC:level='requireAdministrator'
        
    - name: Verify build
      run: |
        if (Test-Path "build\Inferno.exe") {
          Write-Host "Build successful! Inferno.exe created."
          Get-Item "build\Inferno.exe" | Select-Object Name, Length, LastWriteTime
        } else {
          Write-Error "Build failed! Inferno.exe not found."
          exit 1
        }
      shell: pwsh
      
    - name: Create resources folder
      run: |
        mkdir build\resources
        echo "Place inferno.png logo here" > build\resources\README.txt
      
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Inferno-USB-Creator-Windows
        path: |
          build/Inferno.exe
          build/resources/
        retention-days: 90
        
    - name: Create Release
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v2.0.0-${{ github.run_number }}
        name: Inferno USB Creator v2.0.0 Build ${{ github.run_number }}
        body: |
          ## Inferno USB Creator - Advanced Bootable USB Tool
          
          **Developer:** Ahmed Nour Ahmed (Qena, Egypt)
          
          ### Features:
          - ✅ Multi-boot USB support
          - ✅ UEFI & Legacy BIOS compatibility
          - ✅ Persistent storage partition creation
          - ✅ Data verification after write
          - ✅ USB backup and restore
          - ✅ Speed testing capabilities
          - ✅ Secure Boot support
          - ✅ Multiple file systems (FAT32, NTFS, exFAT)
          - ✅ Bad blocks checking
          - ✅ Compression support
          - ✅ Extended label and icon files
          
          ### System Requirements:
          - Windows 7 or later
          - Administrator privileges required
          - USB device for bootable media creation
          
          ### Installation:
          1. Download Inferno.exe
          2. Place inferno.png logo in the same directory (optional)
          3. Run as Administrator
          
          ### Usage:
          1. Select your USB device
          2. Browse for ISO file
          3. Configure options (file system, partition scheme, etc.)
          4. Click START to begin
          
          **⚠️ WARNING:** All data on the selected USB device will be erased!
          
          ### Build Info:
          - Build Number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          - Date: ${{ github.event.head_commit.timestamp }}
        files: |
          build/Inferno.exe
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
